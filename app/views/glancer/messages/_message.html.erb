<div class="message <%= message.role %> max-w-3xl mx-auto flex <%= message.user? ? 'justify-end' : 'justify-start' %>">
  <div class="flex <%= message.user? ? 'justify-end' : 'justify-start' %> gap-3 <%= "max-w-[90%] my-8" if message.user? %> w-full group relative">
    <div class="flex flex-col gap-1 w-full">
      <div class="relative max-w-3xl">
        <%if message.user? %>
          <div class="message-content py-4 px-4 rounded-s-xl rounded-br-xl text-sm leading-relaxed prose dark:prose-invert max-w-none bg-gray-50 text-gray-900 dark:bg-gray-600 dark:text-gray-50">
            <%= raw Glancer::Utils::MarkdownHelper.markdown_to_html(message.content) %>
          </div>
          <button
            type="button"
            data-controller="chat"
            class="absolute p-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-opacity -bottom-8 right-0 opacity-0 group-hover:opacity-100"
            data-action="click->chat#copy"
            data-message="<%= j message.content %>"
            aria-label="Copy message"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400" fill="#F3F4F6" stroke="#F3F4F6" viewBox="0 0 448 512"><path d="M192 0c-35.3 0-64 28.7-64 64l0 256c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-200.6c0-17.4-7.1-34.1-19.7-46.2L370.6 17.8C358.7 6.4 342.8 0 326.3 0L192 0zM64 128c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l192 0c35.3 0 64-28.7 64-64l0-16-64 0 0 16-192 0 0-256 16 0 0-64-16 0z"/></svg>
          </button>
        <% end %>


        <% if message.assistant? %>
          <div class="message-content rounded-2xl text-sm leading-relaxed prose dark:prose-invert max-w-none">
            <%= raw Glancer::Utils::MarkdownHelper.markdown_to_html(message.content) %>
          </div>
          <% if message.successful? %>
            <div class="mt-4 px-4 rounded-lg bg-gray-800 border border-gray-700" data-controller="message">
              <span class="text-xs font-mono text-gray-400">
                <%= raw Glancer::Utils::MarkdownHelper.markdown_to_html("```sql\n#{message.sql}\n```") %>
              </span>

              <div class="flex items-center justify-between mt-2 gap-2">
              <button class="w-fit-full px-3 py-1 bg-primary-600 hover:bg-primary-700 text-white text-xs rounded-full flex items-center gap-2 transition"
                        data-action="click->message#runQuery"
                        data-message-id="<%= message.id %>"
                        data-message-target="runBtn">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3.5l11 6.5-11 6.5V3.5z"/></svg>
                  <span>Executar Consulta</span>
                </button>

                <div>
                  <button class="hidden text-[10px] text-gray-400 hover:text-white underline" 
                          data-message-id="download-csv-<%= message.id %>"
                          data-message-target="downloadBtn"
                          data-action="click->message#exportToCSV">Baixar CSV</button>
                </div>
              </div>

              <div id="results-<%= message.id %>" data-message-target="resultsContainer" class="mt-2 overflow-x-auto">
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

